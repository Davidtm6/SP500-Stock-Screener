{% extends "layout.html"%}

{% block content %}
<script>
    /**
     * Stock Portfolio Management Interface
     * 
     * This module provides functionality for managing a stock portfolio including:
     * - Adding multiple stock symbols via modal interface
     * - Removing individual stocks with confirmation
     * - Real-time filtering by financial metrics
     * - AJAX-based CRUD operations for seamless UX
     * 
     * Dependencies: jQuery, Semantic UI
     * API Endpoints: POST /stock, DELETE /stock/{id}
     */
    $(document).ready(function(){
        // =====================================
        // ADD STOCK MODAL FUNCTIONALITY
        // =====================================
        $("#add_stock").click(function(){
            $('.ui.modal').modal('show');
        })
        /**
         * Event handler for saving multiple stock symbols
         * 
         * Process:
         * 1. Parse textarea input (one symbol per line)
         * 2. Send individual POST requests for each symbol
         * 3. Close modal and refresh page to show new data
         * 
         * Note: Uses setTimeout for page reload to allow API calls to complete
         */
        $("#save").click(function(){
            var stocks = $("#stocks").val();
            console.log(stocks);

            var stocks = stocks.split("\n");

            for(var i = 0; i < stocks.length; ++i){
                // AJAX POST request to add stock to portfolio
                $.ajax({
                    url: '/stock',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({"symbol": stocks[i]}),
                    dataType: 'json',

                })
            }
            // Close modal
            $('.ui.modal').modal('hide');

            // Reload page after 2 seconds to display updated stock list
            setTimeout(function() {
                location.reload();
            }, 2000);
        });
        
        // =====================================
        // REMOVE STOCK FUNCTIONALITY
        // =====================================

        $(".remove-stock").click(function(){
            var stockId = $(this).data('stock-id');
            var stockSymbol = $(this).data('stock-symbol');
            var row = $(this).closest('tr');
            
            if(confirm('Are you sure you want to remove ' + stockSymbol + '?')) {
                // AJAX DELETE request to remove stock from portfolio
                $.ajax({
                    url: '/stock/' + stockId,
                    type: 'DELETE',
                    success: function(response) {
                        if(response.code === 'success') {
                            row.fadeOut(300, function() {
                                $(this).remove();
                            });
                            console.log('Stock removed successfully');
                        } 
                    },
                    
                    error: function(xhr, status, error) {
                        alert('Error removing stock: ' + error);
                        console.log('Error:', error);
                    }
                });
            }
        });
    });
</script>

<!-- ===================================== -->
<!-- FILTERING FORM                  -->
<!-- ===================================== -->
<form>
<div class = "ui input">
    <input name="forward_pe" type="text" placeholder="P/E Ratio" value = "{{ forward_pe }}">
</div>
<div class = "ui input">
    <input name="dividend_yield" type="text" placeholder="Dividend Yield" value = "{{ dividend_yield }}">
</div>

<div class="ui checkbox">
    <input name="ma50" type="checkbox" name="example" {% if ma_50 %}checked="checked"{% endif %}>
    <label>Above 50 Day MA</label>
</div>
<div class="ui checkbox">
    <input name="ma200" type="checkbox" name="example" {% if ma_200 %}checked="checked"{% endif %}>
    <label>Above 200 Day MA</label>
</div>

<button type="submit" class="ui button primary">
    Filter
</button>
</form>

<!-- ===================================== -->
<!-- ADD STOCK BUTTON                      -->
<!-- ===================================== -->
<div style="margin: 20px 0;">
    <button id="add_stock" class="ui button green">
        <i class="plus icon"></i>
        Add Stock Symbol
    </button>
</div>

<!-- ===================================== -->
<!-- STOCK PORTFOLIO TABLE                 -->
<!-- ===================================== -->
 <!--
    Main data table displaying current stock portfolio
    
    Columns:
    - Symbol: Stock ticker symbol
    - Price: Current market price
    - Forward P/E: Forward price-to-earnings ratio
    - Dividend Yield: Annual dividend as percentage of price
    - 50/200 Day MA: Moving average indicators
    - Remove button for each stock
    
-->
<table class="ui celled table">
    <thead>
    <tr>
    <th>Symbol</th>
    <th>Price</th>
    <th>Forward P/E Ratio</th>
    <th>Dividend Yield</th>
    <th>50 Day MA</th>
    <th>200 Day MA</th>
    <th>Actions</th>
    </tr></thead>
    <tbody>
        {% for stock in stocks %}
        <tr>
            <td>{{ stock.symbol }}</td>
            <td>{{ stock.price }}</td>
            <td>{{ stock.forward_pe }}</td>
            <td>{{ stock.dividend_yield }}</td>
            <td>{{ stock.ma50 }}</td>
            <td>{{ stock.ma200 }}</td>
            <td>
                <button class="ui button red mini remove-stock" 
                        data-stock-id="{{ stock.id }}" 
                        data-stock-symbol="{{ stock.symbol }}"
                        title="Remove {{ stock.symbol }}">
                    <i class="trash icon"></i>
                    Remove
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ===================================== -->
<!-- ADD STOCKS MODAL DIALOG              -->
<!-- ===================================== -->
<!--
    Modal dialog for bulk addition of stock symbols
    
    Features:
    - Multi-line textarea for entering multiple symbols
    - Placeholder text showing expected format
    - Cancel and Save actions
    - Semantic UI modal component
    
    Expected input format: One stock symbol per line
--> 
<div class="ui modal">
    <i class="close icon"></i>
    <div class="header">
        Add Stock Symbols
    </div>
    <div class="content">
        <div class="ui form">
            <div class="field">
                <label>Enter Stock Symbols (one per line)</label>
                <textarea id="stocks" placeholder="AAPL&#10;MSFT&#10;GOOGL" rows="5"></textarea>
            </div>
        </div>
    </div>
    <div class="actions">
        <div class="ui button" onclick="$('.ui.modal').modal('hide')">
            Cancel
        </div>
        <div id="save" class="ui positive right labeled icon button">
            Add Stock Symbols
            <i class="plus icon"></i>
        </div>
    </div>
</div>
{% endblock %}